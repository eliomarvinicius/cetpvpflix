{% extends 'base.html' %}
{% load static %}

{% block title %}{{ media.title }} - CETPVPFLIX{% endblock %}

{% block content %}
<!-- Header Section com Backdrop -->
<section class="position-relative text-white overflow-hidden" 
         style="min-height: 60vh; {% if media.backdrop_path %}background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)), url('https://image.tmdb.org/t/p/original{{ media.backdrop_path }}') center/cover;{% else %}background: linear-gradient(45deg, #1a1a1a, #FF6B35);{% endif %}">
    <div class="container h-100 d-flex align-items-end py-5">
        <div class="row w-100">
            <div class="col-md-3 mb-4">
                <!-- Poster -->
                <div class="text-center">
                    {% if media.poster_path %}
                        <img src="https://image.tmdb.org/t/p/w500{{ media.poster_path }}" 
                             alt="{{ media.title }}" 
                             class="img-fluid rounded shadow-lg"
                             style="max-height: 500px;">
                    {% else %}
                        <div class="bg-secondary rounded d-flex align-items-center justify-content-center" 
                             style="height: 500px; width: 100%;">
                            <i class="fas {% if media.media_type == 'tv' %}fa-tv{% else %}fa-film{% endif %} fa-5x text-muted"></i>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-9">
                <div class="pb-4">
                    <!-- T√≠tulo e Informa√ß√µes B√°sicas -->
                    <h1 class="display-4 fw-bold mb-3">{{ media.title }}</h1>
                    
                    {% if media.tagline %}
                    <p class="lead fst-italic mb-4">"{{ media.tagline }}"</p>
                    {% endif %}
                    
                    <div class="d-flex flex-wrap gap-3 mb-4">
                        <!-- Avalia√ß√£o -->
                        {% if media.vote_average %}
                        <div class="d-flex align-items-center px-3 py-2 rounded" style="background-color: #FF6B35;">
                            <i class="fas fa-star me-2"></i>
                            <span class="fw-bold">{{ media.vote_average|floatformat:1 }}/10</span>
                            <small class="ms-2">({{ media.vote_count }} votos)</small>
                        </div>
                        {% endif %}
                        
                        <!-- Ano -->
                        {% if media.release_date %}
                        <div class="bg-dark bg-opacity-50 px-3 py-2 rounded">
                            <i class="fas fa-calendar me-2"></i>{{ media.release_date.year }}
                        </div>
                        {% endif %}
                        
                        <!-- Dura√ß√£o/Temporadas -->
                        {% if media.runtime %}
                        <div class="bg-dark bg-opacity-50 px-3 py-2 rounded">
                            <i class="fas fa-clock me-2"></i>{{ media.runtime }}min
                        </div>
                        {% elif media.number_of_seasons %}
                        <div class="bg-dark bg-opacity-50 px-3 py-2 rounded">
                            <i class="fas fa-list me-2"></i>{{ media.number_of_seasons }} temporada{{ media.number_of_seasons|pluralize }}
                        </div>
                        {% endif %}
                        
                        <!-- Status (para s√©ries) -->
                        {% if media.media_type == 'tv' and media.status %}
                        <div class="bg-dark bg-opacity-50 px-3 py-2 rounded">
                            <i class="fas fa-info-circle me-2"></i>
                            {% if media.status == 'ended' %}
                                Finalizada
                            {% elif media.status == 'returning' %}
                                Renovada
                            {% elif media.status == 'canceled' %}
                                Cancelada
                            {% else %}
                                {{ media.status|title }}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- G√™neros -->
                    {% if media.genres.exists %}
                    <div class="mb-4">
                        {% for genre in media.genres.all %}
                            <span class="badge bg-secondary me-2 fs-6">{{ genre.name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- A√ß√µes do Usu√°rio -->
                    {% if user.is_authenticated %}
                    <div class="d-flex gap-3 mb-4">
                        <button class="btn {% if is_favorite %}btn-danger{% else %}btn-outline-light{% endif %} btn-lg favorite-btn" 
                                data-media-id="{{ media.pk }}"
                                data-is-favorite="{{ is_favorite|yesno:'true,false' }}">
                            <i class="{% if is_favorite %}fas fa-heart{% else %}far fa-heart{% endif %} me-2 heart-icon"></i>
                            <span class="button-text">
                                {% if is_favorite %}
                                    Remover dos Favoritos
                                {% else %}
                                    Adicionar aos Favoritos
                                {% endif %}
                            </span>
                        </button>
                        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#reviewModal">
                            <i class="fas fa-star me-2"></i>Avaliar
                        </button>
                        {% if not media.pk %}
                        <button class="btn btn-outline-light btn-lg request-btn" data-media-id="{{ media.tmdb_id }}">
                            <i class="fas fa-plus me-2"></i>Solicitar Adi√ß√£o
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Sinopse -->
                    {% if media.overview %}
                    <div>
                        <h5 class="mb-3">Sinopse</h5>
                        <p class="fs-6 lh-lg">{{ media.overview }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Informa√ß√µes Detalhadas -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Coluna Principal -->
            <div class="col-lg-8">
                <!-- Elenco -->
                {% if cast %}
                <div class="mb-5">
                    <h3 class="mb-4">Elenco Principal</h3>
                    <div class="row">
                        {% for actor in cast|slice:":8" %}
                        <div class="col-md-3 col-sm-4 col-6 mb-3">
                            <div class="text-center">
                                {% if actor.profile_path %}
                                    <img src="https://image.tmdb.org/t/p/w300{{ actor.profile_path }}" 
                                         alt="{{ actor.name }}" 
                                         class="img-fluid rounded-circle mb-2"
                                         style="width: 80px; height: 80px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-secondary rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center"
                                         style="width: 80px; height: 80px;">
                                        <i class="fas fa-user text-muted"></i>
                                    </div>
                                {% endif %}
                                <h6 class="mb-0">{{ actor.name }}</h6>
                                {% if actor.character %}
                                <small class="text-muted">{{ actor.character }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                                    <!-- Avalia√ß√£o do usu√°rio (se existir) -->
                    {% if user.is_authenticated and user_review %}
                    <div class="user-review-section mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-star me-2"></i>
                            <strong>Sua Avalia√ß√£o:</strong>
                            <div class="ms-2">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= user_review.rating %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="ms-2 badge bg-warning text-dark">{{ user_review.rating }}/5</span>
                        </div>
                        {% if user_review.comment %}
                        <div class="mt-2">
                            <small class="text-muted">Seu coment√°rio:</small>
                            <p class="mb-0 mt-1">"{{ user_review.comment }}"</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Avalia√ß√µes -->
                <div id="reviews" class="mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="mb-0">Avalia√ß√µes dos Usu√°rios</h3>
                        {% if user.is_authenticated %}
                            {% if user_review %}
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editReviewModal">
                                        <i class="fas fa-edit me-2"></i>Editar Minha Avalia√ß√£o
                                    </button>
                                </div>
                            {% else %}
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reviewModal">
                                    <i class="fas fa-plus me-2"></i>Adicionar Avalia√ß√£o
                                </button>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    {% if reviews %}
                    <div class="row">
                        {% for review in reviews %}
                        <div class="col-12 mb-4">
                            <div class="card border-0 shadow-sm" style="border-left: 4px solid #FF6B35 !important;">
                                <div class="card-body bg-white"
                                     style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                 style="background-color: #FF6B35; width: 40px; height: 40px;">
                                                {{ review.user.first_name.0|default:review.user.username.0|upper }}
                                            </div>
                                            <div>
                                                <h6 class="mb-0">{{ review.user.get_full_name|default:review.user.username }}</h6>
                                                <div class="stars">
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= review.rating %}
                                                            <i class="fas fa-star text-warning"></i>
                                                        {% else %}
                                                            <i class="far fa-star text-muted"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ review.created_at|date:"d/m/Y H:i" }}</small>
                                    </div>
                                    {% if review.comment %}
                                    <p class="mb-3">{{ review.comment }}</p>
                                    {% endif %}
                                    
                                    <!-- Likes -->
                                    {% if user.is_authenticated %}
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-sm btn-outline-primary like-btn me-3" 
                                                data-review-id="{{ review.pk }}">
                                            <i class="fas fa-thumbs-up me-1"></i>
                                            <span class="like-count">{{ review.likes.count }}</span>
                                        </button>
                                        {% if review.user == user %}
                                        <button class="btn btn-sm btn-outline-secondary me-2 edit-review-btn"
                                                data-review-id="{{ review.pk }}"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editReviewModal">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-review-btn"
                                                data-review-id="{{ review.pk }}"
                                                data-media-title="{{ media.title }}"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteConfirmModal">
                                            <i class="fas fa-trash"></i> Excluir
                                        </button>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Mais avalia√ß√µes -->
                    {% if reviews.count > 10 %}
                    <div class="text-center">
                        <p class="text-muted">Mostrando as 10 avalia√ß√µes mais recentes de {{ reviews_count }} total</p>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-star fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhuma avalia√ß√£o ainda</h5>
                        <p class="text-muted">Seja o primeiro a avaliar este {{ media.media_type|yesno:'programa,filme' }}!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Informa√ß√µes T√©cnicas -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Informa√ß√µes</h5>
                    </div>
                    <div class="card-body">
                        {% if media.original_language %}
                        <div class="row mb-2">
                            <div class="col-6"><strong>Idioma Original:</strong></div>
                            <div class="col-6">{{ media.original_language|upper }}</div>
                        </div>
                        {% endif %}
                        
                        {% if media.release_date %}
                        <div class="row mb-2">
                            <div class="col-6"><strong>{% if media.media_type == 'tv' %}Primeira Exibi√ß√£o:{% else %}Lan√ßamento:{% endif %}</strong></div>
                            <div class="col-6">{{ media.release_date|date:"d/m/Y" }}</div>
                        </div>
                        {% endif %}
                        
                        {% if media.budget %}
                        <div class="row mb-2">
                            <div class="col-6"><strong>Or√ßamento:</strong></div>
                            <div class="col-6">${{ media.budget|floatformat:0 }}</div>
                        </div>
                        {% endif %}
                        
                        {% if media.revenue %}
                        <div class="row mb-2">
                            <div class="col-6"><strong>Bilheteria:</strong></div>
                            <div class="col-6">${{ media.revenue|floatformat:0 }}</div>
                        </div>
                        {% endif %}
                        
                        {% if media.number_of_episodes %}
                        <div class="row mb-2">
                            <div class="col-6"><strong>Epis√≥dios:</strong></div>
                            <div class="col-6">{{ media.number_of_episodes }}</div>
                        </div>
                        {% endif %}
                        
                        {% if media.homepage %}
                        <div class="row">
                            <div class="col-12">
                                <a href="{{ media.homepage }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-external-link-alt me-2"></i>Site Oficial
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Estat√≠sticas -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Estat√≠sticas</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6"><strong>Avalia√ß√µes:</strong></div>
                            <div class="col-6">{{ reviews_count|default:0 }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6"><strong>Nos Favoritos:</strong></div>
                            <div class="col-6">{{ media.favorites.count }} usu√°rio{{ media.favorites.count|pluralize }}</div>
                        </div>
                        {% if average_rating %}
                        <div class="row">
                            <div class="col-6"><strong>M√©dia Local:</strong></div>
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <div class="stars me-2">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= average_rating %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star text-muted"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    {{ average_rating|floatformat:1 }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal de Avalia√ß√£o -->
{% if user.is_authenticated %}
<!-- Modal para adicionar nova avalia√ß√£o -->
{% if not user_review %}
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">Avaliar {{ media.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{% url 'reviews:add_review' media.pk %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="media" value="{{ media.pk }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Sua Avalia√ß√£o</label>
                        <div class="rating-input">
                            {% for i in "12345" %}
                            <input type="radio" name="rating" value="{{ forloop.counter }}" id="star{{ forloop.counter }}" required>
                            <label for="star{{ forloop.counter }}"><i class="far fa-star"></i></label>
                            {% endfor %}
                        </div>
                        <small class="text-muted">Clique nas estrelas para avaliar</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="comment" class="form-label">Coment√°rio (opcional)</label>
                        <textarea class="form-control" name="comment" id="comment" rows="4" 
                                  placeholder="Compartilhe sua opini√£o sobre este {{ media.get_media_type_display|lower }}..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Enviar Avalia√ß√£o</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal para editar avalia√ß√£o existente -->
{% if user_review %}
<div class="modal fade" id="editReviewModal" tabindex="-1" aria-labelledby="editReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReviewModalLabel">Editar Avalia√ß√£o de {{ media.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form method="POST" action="{% if user_review %}{% url 'reviews:edit_review' user_review.pk %}{% else %}#{% endif %}" id="editReviewForm">
                <div class="modal-body">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Sua Avalia√ß√£o</label>
                        <div class="rating-input">
                            {% for i in "12345" %}
                            <input type="radio" name="rating" value="{{ forloop.counter }}" 
                                   id="edit_star{{ forloop.counter }}" 
                                   {% if user_review.rating == forloop.counter %}checked{% endif %} required>
                            <label for="edit_star{{ forloop.counter }}"><i class="far fa-star"></i></label>
                            {% endfor %}
                        </div>
                        <small class="text-muted">Sua avalia√ß√£o atual: {{ user_review.rating }} estrela{{ user_review.rating|pluralize }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_comment" class="form-label">Coment√°rio (opcional)</label>
                        <textarea class="form-control" name="comment" id="edit_comment" rows="4" 
                                  placeholder="Compartilhe sua opini√£o sobre este {{ media.get_media_type_display|lower }}...">{{ user_review.comment }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger delete-review-btn" 
                            data-review-id="{{ user_review.pk }}" 
                            data-media-title="{{ media.title }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteConfirmModal">Excluir Avalia√ß√£o</button>
                    <button type="submit" class="btn btn-primary">Atualizar Avalia√ß√£o</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de Confirma√ß√£o para Exclus√£o -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Confirmar Exclus√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-trash-alt fa-3x text-danger"></i>
                </div>
                <h6 class="fw-bold mb-3">Tem certeza que deseja excluir sua avalia√ß√£o?</h6>
                <p class="text-muted mb-0" id="deleteConfirmText">Esta a√ß√£o n√£o pode ser desfeita.</p>
            </div>
            <div class="modal-footer border-top-0 justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash-alt me-2"></i>Excluir Avalia√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.rating-input {
    display: flex;
    flex-direction: row-reverse;
    justify-content: center;
    gap: 0.25rem;
}

.rating-input input {
    display: none;
}

.rating-input label {
    cursor: pointer;
    font-size: 2rem;
    color: #ddd;
    transition: all 0.2s ease;
}

.rating-input label:hover {
    color: #FF6B35;
    transform: scale(1.1);
}

.rating-input input:checked ~ label,
.rating-input input:checked ~ label ~ label {
    color: #FF6B35;
}

.rating-input label:hover ~ label {
    color: #FF6B35;
}

/* Mostrar avalia√ß√£o do usu√°rio se existir */
.user-review-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #FF6B35;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.1);
    position: relative;
    overflow: hidden;
}

.user-review-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, #FF6B35, #ff8c42);
}

.user-review-section .d-flex {
    position: relative;
    z-index: 2;
}

.user-review-section strong {
    color: #333;
    font-weight: 600;
}

.user-review-section .badge {
    background: #FF6B35 !important;
    color: white !important;
    font-weight: 500;
}

.user-review-section p {
    color: #555;
    line-height: 1.6;
}

.user-review-section small {
    color: #666 !important;
}

.user-review-badge {
    background: linear-gradient(45deg, #FF6B35, #ff6b35);
    border: 2px solid #fff;
    box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
}

/* Anima√ß√µes para bot√£o de favoritos */
.favorite-btn {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.favorite-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.favorite-btn .heart-icon {
    transition: all 0.3s ease;
}

.favorite-btn:hover .heart-icon {
    transform: scale(1.1);
}

/* Anima√ß√µes espec√≠ficas */
@keyframes heartPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); color: #e74c3c; }
    100% { transform: scale(1); }
}

@keyframes heartBreak {
    0% { transform: scale(1) rotate(0deg); opacity: 1; }
    50% { transform: scale(0.8) rotate(-5deg); opacity: 0.7; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

@keyframes bounce {
    0%, 20%, 60%, 100% { transform: translateY(0); }
    40% { transform: translateY(-5px); }
    80% { transform: translateY(-2px); }
}

/* Efeito visual para bot√µes de like */
.like-btn {
    transition: all 0.2s ease;
}

.like-btn:hover {
    transform: scale(1.05);
}

/* Toast container styling */
.toast-container {
    z-index: 1055 !important;
}

.toast {
    backdrop-filter: blur(10px);
    border-radius: 15px;
}

/* Responsividade */
@media (max-width: 768px) {
    .favorite-btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .d-flex.gap-3.mb-4 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
}

/* Estado de loading */
.btn.opacity-50 {
    opacity: 0.5 !important;
    cursor: not-allowed;
}

/* Melhorias visuais gerais */
.card {
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.stars i {
    transition: color 0.2s ease;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Funcionalidade de favoritos com feedback visual
    const favoriteBtn = document.querySelector('.favorite-btn');
    if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function() {
            const mediaId = this.dataset.mediaId;
            const icon = this.querySelector('.heart-icon');
            const buttonText = this.querySelector('.button-text');
            const isCurrentlyFavorite = this.dataset.isFavorite === 'true';
            
            // Desabilitar bot√£o durante a requisi√ß√£o
            this.disabled = true;
            this.classList.add('opacity-50');
            
            fetch(`{% url 'catalog:ajax_toggle_favorite' 0 %}`.replace('0', mediaId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Atualizar visual do bot√£o
                    if (data.is_favorite) {
                        // Tornou-se favorito
                        icon.className = 'fas fa-heart me-2 heart-icon';
                        buttonText.textContent = 'Remover dos Favoritos';
                        this.classList.remove('btn-outline-light');
                        this.classList.add('btn-danger');
                        this.dataset.isFavorite = 'true';
                        
                        // Anima√ß√£o de sucesso
                        icon.style.animation = 'heartPulse 0.6s ease-in-out';
                        
                        showToast('‚ù§Ô∏è Adicionado aos favoritos!', 'success');
                    } else {
                        // Removido dos favoritos
                        icon.className = 'far fa-heart me-2 heart-icon';
                        buttonText.textContent = 'Adicionar aos Favoritos';
                        this.classList.remove('btn-danger');
                        this.classList.add('btn-outline-light');
                        this.dataset.isFavorite = 'false';
                        
                        // Anima√ß√£o de remo√ß√£o
                        icon.style.animation = 'heartBreak 0.4s ease-in-out';
                        
                        showToast('üíî Removido dos favoritos', 'info');
                    }
                } else {
                    showToast('Erro ao atualizar favoritos. Tente novamente.', 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showToast('Erro de conex√£o. Tente novamente.', 'error');
            })
            .finally(() => {
                // Reabilitar bot√£o
                this.disabled = false;
                this.classList.remove('opacity-50');
                
                // Remover anima√ß√£o ap√≥s completar
                setTimeout(() => {
                    if (icon) icon.style.animation = '';
                }, 600);
            });
        });
    }
    
    // Funcionalidade de likes nas avalia√ß√µes
    const likeButtons = document.querySelectorAll('.like-btn');
    likeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.dataset.reviewId;
            const likeCount = this.querySelector('.like-count');
            const icon = this.querySelector('i');
            
            // Anima√ß√£o visual imediata
            this.disabled = true;
            icon.style.animation = 'bounce 0.3s ease-in-out';
            
            fetch(`{% url 'reviews:ajax_like_review' 0 %}`.replace('0', reviewId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    likeCount.textContent = data.total_likes;
                    if (data.liked) {
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                        icon.className = 'fas fa-thumbs-up me-1';
                        showToast('üëç Obrigado pelo like!', 'success');
                    } else {
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline-primary');
                        icon.className = 'far fa-thumbs-up me-1';
                        showToast('Like removido', 'info');
                    }
                } else {
                    showToast('Erro ao curtir. Tente novamente.', 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showToast('Erro ao curtir. Tente novamente.', 'error');
            })
            .finally(() => {
                this.disabled = false;
                setTimeout(() => {
                    icon.style.animation = '';
                }, 300);
            });
        });
    });
    
    // Gerenciamento de modais de avalia√ß√µes
    document.querySelectorAll('.edit-review-btn').forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.dataset.reviewId;
            const editForm = document.getElementById('editReviewForm');
            if (editForm) {
                editForm.action = `/reviews/edit/${reviewId}/`;
            }
        });
    });
    
    // Bot√µes de exclus√£o de avalia√ß√£o com modal
    let reviewToDelete = null;
    document.querySelectorAll('.delete-review-btn').forEach(button => {
        button.addEventListener('click', function() {
            reviewToDelete = {
                id: this.dataset.reviewId,
                mediaTitle: this.dataset.mediaTitle
            };
            document.getElementById('deleteConfirmText').textContent = 
                `Tem certeza que deseja excluir sua avalia√ß√£o de "${reviewToDelete.mediaTitle}"? Esta a√ß√£o n√£o pode ser desfeita.`;
        });
    });
    
    // Confirmar exclus√£o
    document.getElementById('confirmDeleteBtn')?.addEventListener('click', function() {
        if (!reviewToDelete) return;
        
        // Criar formul√°rio tempor√°rio para envio
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/reviews/delete/${reviewToDelete.id}/`;
        
        // Adicionar CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = getCookie('csrftoken');
        form.appendChild(csrfInput);
        
        // Adicionar ao DOM e submeter
        document.body.appendChild(form);
        form.submit();
        
        // Fechar modal
        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
    });
    
    // Simples valida√ß√£o de formul√°rios de avalia√ß√£o
    const reviewForms = document.querySelectorAll('#reviewModal form, #editReviewModal form');
    reviewForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const rating = this.querySelector('input[name="rating"]:checked');
            if (!rating) {
                e.preventDefault();
                showToast('Por favor, selecione uma avalia√ß√£o.', 'warning');
                return;
            }
        });
    });
});

// Fun√ß√£o para obter cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fun√ß√£o para mostrar toast messages
function showToast(message, type = 'info') {
    // Encontrar ou criar container de toasts
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1055';
        document.body.appendChild(toastContainer);
    }
    
    // Determinar cor do toast
    let bgColor = 'bg-info';
    if (type === 'success') bgColor = 'bg-success';
    else if (type === 'error') bgColor = 'bg-danger';
    else if (type === 'warning') bgColor = 'bg-warning';
    
    // Criar toast
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white ${bgColor} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body fw-bold">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                    data-bs-dismiss="toast" aria-label="Fechar"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Inicializar e mostrar toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: type === 'error' ? 5000 : 3000
    });
    bsToast.show();
    
    // Remover toast do DOM ap√≥s ser ocultado
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}